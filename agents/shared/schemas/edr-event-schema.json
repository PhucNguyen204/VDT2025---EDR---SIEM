{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "EDR Event Schema",
  "description": "Schema chuẩn cho events từ EDR agents theo format ECS",
  "type": "object",
  "required": ["@timestamp", "host", "agent", "event", "ecs"],
  "properties": {
    "@timestamp": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp của event theo ISO 8601"
    },
    "ecs": {
      "type": "object",
      "properties": {
        "version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+$",
          "description": "Phiên bản ECS schema"
        }
      },
      "required": ["version"]
    },
    "host": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier cho host"
        },
        "name": {
          "type": "string",
          "description": "Hostname của endpoint"
        },
        "os": {
          "type": "object",
          "properties": {
            "platform": {
              "type": "string",
              "enum": ["windows", "linux", "macos"],
              "description": "Platform của OS"
            },
            "family": {
              "type": "string",
              "enum": ["windows", "unix"],
              "description": "Family của OS"
            },
            "name": {
              "type": "string",
              "description": "Tên OS (Windows 10, Ubuntu, etc.)"
            },
            "version": {
              "type": "string",
              "description": "Phiên bản OS"
            }
          }
        }
      },
      "required": ["id", "name"]
    },
    "agent": {
      "type": "object",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier cho agent"
        },
        "type": {
          "type": "string",
          "description": "Loại agent (vector-edr, vector-edr-linux)"
        },
        "version": {
          "type": "string",
          "description": "Phiên bản agent"
        }
      },
      "required": ["id", "type", "version"]
    },
    "event": {
      "type": "object",
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["event", "alert", "metric", "state"],
          "description": "Loại event"
        },
        "category": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "authentication", "authorization", "configuration", "database",
              "driver", "email", "file", "host", "iam", "intrusion_detection",
              "library", "malware", "network", "package", "process", "registry",
              "session", "threat", "vulnerability", "web"
            ]
          },
          "description": "Danh mục event theo ECS"
        },
        "type": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "access", "admin", "allowed", "change", "connection", "creation",
              "deletion", "denied", "end", "error", "group", "info", "installation",
              "protocol", "start", "user"
            ]
          },
          "description": "Loại event theo ECS"
        },
        "action": {
          "type": "string",
          "description": "Hành động cụ thể của event"
        },
        "outcome": {
          "type": "string",
          "enum": ["success", "failure", "unknown"],
          "description": "Kết quả của event"
        },
        "severity": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"],
          "description": "Mức độ nghiêm trọng"
        },
        "risk_score": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100,
          "description": "Điểm rủi ro (0-100)"
        },
        "provider": {
          "type": "string",
          "description": "Event provider (Microsoft-Windows-Sysmon, etc.)"
        },
        "code": {
          "type": "string",
          "description": "Mã event (Event ID)"
        },
        "module": {
          "type": "string",
          "description": "Module sinh ra event"
        },
        "original": {
          "type": "string",
          "description": "Nội dung gốc của event"
        }
      },
      "required": ["kind"]
    },
    "process": {
      "type": "object",
      "properties": {
        "pid": {
          "type": "integer",
          "description": "Process ID"
        },
        "entity_id": {
          "type": "string",
          "description": "Unique identifier cho process (GUID)"
        },
        "executable": {
          "type": "string",
          "description": "Đường dẫn đầy đủ tới executable"
        },
        "name": {
          "type": "string",
          "description": "Tên file executable"
        },
        "command_line": {
          "type": "string",
          "description": "Command line đầy đủ"
        },
        "start": {
          "type": "string",
          "format": "date-time",
          "description": "Thời gian khởi động process"
        },
        "hash": {
          "type": "object",
          "properties": {
            "sha256": {
              "type": "string",
              "pattern": "^[a-fA-F0-9]{64}$",
              "description": "SHA256 hash của executable"
            },
            "md5": {
              "type": "string",
              "pattern": "^[a-fA-F0-9]{32}$",
              "description": "MD5 hash của executable"
            }
          }
        },
        "parent": {
          "type": "object",
          "properties": {
            "pid": {
              "type": "integer",
              "description": "Parent process ID"
            },
            "entity_id": {
              "type": "string",
              "description": "Parent process GUID"
            },
            "executable": {
              "type": "string",
              "description": "Đường dẫn parent executable"
            },
            "name": {
              "type": "string",
              "description": "Tên parent executable"
            },
            "command_line": {
              "type": "string",
              "description": "Parent command line"
            }
          }
        }
      }
    },
    "network": {
      "type": "object",
      "properties": {
        "transport": {
          "type": "string",
          "enum": ["tcp", "udp", "icmp"],
          "description": "Network transport protocol"
        },
        "direction": {
          "type": "string",
          "enum": ["inbound", "outbound", "internal", "external", "unknown"],
          "description": "Hướng của network connection"
        },
        "type": {
          "type": "string",
          "enum": ["internal", "external"],
          "description": "Loại network (internal/external)"
        },
        "initiated": {
          "type": "boolean",
          "description": "Connection có được khởi tạo bởi process không"
        }
      }
    },
    "source": {
      "type": "object",
      "properties": {
        "ip": {
          "type": "string",
          "format": "ipv4",
          "description": "Source IP address"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535,
          "description": "Source port"
        },
        "domain": {
          "type": "string",
          "description": "Source domain"
        }
      }
    },
    "destination": {
      "type": "object",
      "properties": {
        "ip": {
          "type": "string",
          "format": "ipv4",
          "description": "Destination IP address"
        },
        "port": {
          "type": "integer",
          "minimum": 1,
          "maximum": 65535,
          "description": "Destination port"
        },
        "domain": {
          "type": "string",
          "description": "Destination domain"
        }
      }
    },
    "user": {
      "type": "object",
      "properties": {
        "name": {
          "type": "string",
          "description": "Username"
        },
        "domain": {
          "type": "string",
          "description": "User domain"
        },
        "id": {
          "type": "string",
          "description": "User ID hoặc SID"
        },
        "target": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Target username (cho RunAs)"
            },
            "domain": {
              "type": "string",
              "description": "Target user domain"
            }
          }
        }
      }
    },
    "file": {
      "type": "object",
      "properties": {
        "path": {
          "type": "string",
          "description": "Đường dẫn đầy đủ tới file"
        },
        "name": {
          "type": "string",
          "description": "Tên file"
        },
        "extension": {
          "type": "string",
          "description": "File extension"
        },
        "size": {
          "type": "integer",
          "description": "Kích thước file (bytes)"
        },
        "created": {
          "type": "string",
          "format": "date-time",
          "description": "Thời gian tạo file"
        },
        "hash": {
          "type": "object",
          "properties": {
            "sha256": {
              "type": "string",
              "pattern": "^[a-fA-F0-9]{64}$"
            },
            "md5": {
              "type": "string",
              "pattern": "^[a-fA-F0-9]{32}$"
            }
          }
        }
      }
    },
    "dns": {
      "type": "object",
      "properties": {
        "question": {
          "type": "object",
          "properties": {
            "name": {
              "type": "string",
              "description": "Domain được query"
            },
            "type": {
              "type": "string",
              "description": "DNS query type (A, AAAA, CNAME, etc.)"
            }
          }
        },
        "answers": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "DNS response answers"
        }
      }
    },
    "threat": {
      "type": "object",
      "properties": {
        "indicators": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "suspicious_process", "network_anomaly", "file_creation",
              "registry_modification", "privilege_escalation", "lateral_movement",
              "data_exfiltration", "command_and_control", "persistence"
            ]
          },
          "description": "Các chỉ số đe dọa được phát hiện"
        },
        "technique": {
          "type": "object",
          "properties": {
            "id": {
              "type": "string",
              "pattern": "^T\\d{4}(\\.\\d{3})?$",
              "description": "MITRE ATT&CK technique ID"
            },
            "name": {
              "type": "string",
              "description": "Tên technique"
            }
          }
        }
      }
    },
    "labels": {
      "type": "object",
      "properties": {
        "environment": {
          "type": "string",
          "enum": ["dev", "staging", "production"],
          "description": "Môi trường triển khai"
        },
        "datacenter": {
          "type": "string",
          "description": "Datacenter location"
        }
      }
    },
    "edr": {
      "type": "object",
      "properties": {
        "processed_at": {
          "type": "string",
          "format": "date-time",
          "description": "Thời gian xử lý bởi agent"
        },
        "agent_version": {
          "type": "string",
          "description": "Phiên bản EDR agent"
        },
        "rule_id": {
          "type": "string",
          "description": "ID của rule phát hiện event"
        },
        "rule_name": {
          "type": "string",
          "description": "Tên rule phát hiện event"
        }
      }
    }
  }
}
